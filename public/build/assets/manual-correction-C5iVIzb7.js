import{r as u,j as e,H as te,L as re,d as S,b as ae}from"./app-BL23_ioL.js";import{A as oe}from"./app-layout-CDpq751G.js";import{C as z,b as ie,c as le,a as G}from"./card-BPYLlYs-.js";import{B as b}from"./badge-J0MIFrA3.js";import{B as h,a as T}from"./button-ErPUhfKM.js";import{I as B}from"./input-CZPc4iR6.js";import{L as O}from"./label-CDDyI8HS.js";import{T as ne}from"./textarea-L_TQdpuK.js";import{C as P}from"./checkbox-BB3F9eKw.js";import{t as p}from"./app-sidebar-layout-BQteZuDl.js";import{a as de}from"./index-63p2o9N5.js";import{a as ce,q as v}from"./index-DW9AIAM8.js";import{E as _}from"./ExamController-DtW2Bo6_.js";import{M as me}from"./MathRenderer-Dmg9cVUs.js";import{P as xe}from"./PreviewStudentAnswer-DcXJbsRy.js";import{L as $,R as ue}from"./RichTextEditor-BBqXt6Vd.js";import{S as pe,a as he,b as fe,c as ge,d as je}from"./sheet-CAKOvksQ.js";import{A as be}from"./arrow-left-DtOF6xQY.js";import{S as q}from"./save-D3ZHDlxg.js";import{C as Ne}from"./circle-alert-Db82dbeJ.js";import{L as ve}from"./loader-circle-CRbCYMqs.js";import{S as ye}from"./sparkles-BWO_tNkc.js";/* empty css            */import"./index-BoQRUedT.js";import"./index-DuTHxAZ2.js";import"./index-BzB_uvRg.js";import"./index-Uqd2XL9l.js";import"./app-shell-jJUctm17.js";import"./index-DFAfDP5U.js";import"./index-CneOgjps.js";import"./dropdown-menu-CNt4bR-q.js";import"./index-CQgWKaQN.js";import"./index-e0nZHYEA.js";import"./index-CCL8Hooa.js";import"./index-63gOiuA7.js";import"./settings-xNbhH6pj.js";import"./index-CO7HXDK1.js";import"./app-logo-icon-Cc_kpyVd.js";import"./users-BFSadU9h.js";import"./calendar-DOhSzEfG.js";import"./index-C3I_bb3G.js";import"./circle-check-DAVIKFey.js";import"./circle-x-Du51Wy4n.js";import"./square-DDqxBGSL.js";import"./square-check-big-CfvcNerE.js";import"./style-CnmbGnv_.js";import"./x-Bvzm8Mbo.js";import"./index-CuzgK42c.js";const n=(s,a)=>({url:n.url(s,a),method:"get"});n.definition={methods:["get","head"],url:"/admin/exams/{exam}/manual-correction"};n.url=(s,a)=>{(typeof s=="string"||typeof s=="number")&&(s={exam:s}),typeof s=="object"&&!Array.isArray(s)&&"id"in s&&(s={exam:s.id}),Array.isArray(s)&&(s={exam:s[0]}),s=ce(s);const i={exam:typeof s.exam=="object"?s.exam.id:s.exam};return n.definition.url.replace("{exam}",i.exam.toString()).replace(/\/+$/,"")+v(a)};n.get=(s,a)=>({url:n.url(s,a),method:"get"});n.head=(s,a)=>({url:n.url(s,a),method:"head"});const w=(s,a)=>({action:n.url(s,a),method:"get"});w.get=(s,a)=>({action:n.url(s,a),method:"get"});w.head=(s,a)=>({action:n.url(s,{[a?.mergeQuery?"mergeQuery":"query"]:{_method:"HEAD",...a?.query??a?.mergeQuery??{}}}),method:"get"});n.form=w;const d=s=>({url:d.url(s),method:"post"});d.definition={methods:["post"],url:"/admin/exams/manual-correction/score"};d.url=s=>d.definition.url+v(s);d.post=s=>({url:d.url(s),method:"post"});const H=s=>({action:d.url(s),method:"post"});H.post=s=>({action:d.url(s),method:"post"});d.form=H;const c=s=>({url:c.url(s),method:"post"});c.definition={methods:["post"],url:"/admin/exams/manual-correction/bulk-score"};c.url=s=>c.definition.url+v(s);c.post=s=>({url:c.url(s),method:"post"});const W=s=>({action:c.url(s),method:"post"});W.post=s=>({action:c.url(s),method:"post"});c.form=W;const m=s=>({url:m.url(s),method:"post"});m.definition={methods:["post"],url:"/admin/exams/manual-correction/ai-grade"};m.url=s=>m.definition.url+v(s);m.post=s=>({url:m.url(s),method:"post"});const R=s=>({action:m.url(s),method:"post"});R.post=s=>({action:m.url(s),method:"post"});m.form=R;const N={index:n,storeScore:d,bulkStoreScore:c,gradeWithAI:m};function gs({exam:s,questions:a,selectedQuestion:i,answers:y}){const[f,g]=u.useState(y);u.useEffect(()=>{g(y)},[y]);const[C,U]=u.useState(""),[k,A]=u.useState(!1),[x,j]=u.useState([]),[D,I]=u.useState(!1),[F,L]=u.useState(null);u.useEffect(()=>{j([])},[i?.id]);const J=t=>{ae.get(N.index({exam:s.id}).url,{question_id:t.id},{preserveState:!0,preserveScroll:!0,only:["selectedQuestion","answers"],onStart:()=>{A(!0),I(!1)},onFinish:()=>A(!1)})},E=(t,r)=>{g(o=>o.map(l=>l.id===t?{...l,score_earned:parseFloat(r)||0}:l))},K=(t,r)=>{g(o=>o.map(l=>l.id===t?{...l,correction_notes:r}:l))},V=async t=>{try{await S.post(N.storeScore().url,{detail_id:t.id,score:t.score_earned,notes:t.correction_notes}),p.success("Score saved")}catch(r){p.error("Failed to save score"),console.error(r)}},Y=()=>{const t=parseFloat(C);if(!isNaN(t)){if(x.length===0){p.error("Please select at least one student to apply bulk score");return}g(r=>r.map(o=>x.includes(o.id)?{...o,score_earned:t}:o)),p.success(`Applied score ${t} to ${x.length} students`)}},X=async t=>{if(i?.question_type==="essay"){L(t.id);try{const r=await S.post(N.gradeWithAI().url,{detail_id:t.id});r.data.success&&(g(o=>o.map(l=>l.id===t.id?{...l,score_earned:parseFloat(r.data.scaled_score),correction_notes:r.data.notes}:l)),p.success("AI Grading Complete",{description:`Score: ${r.data.scaled_score}/${r.data.max_score}`}))}catch(r){console.error("AI Grading Failed:",r),p.error("AI Grading Failed",{description:r.response?.data?.message||"Please check configuration."})}finally{L(null)}}},Z=t=>{j(t?f.map(r=>r.id):[])},Q=(t,r)=>{j(r?o=>[...o,t]:o=>o.filter(l=>l!==t))},ee=async()=>{try{const t=f.map(r=>({detail_id:r.id,score:r.score_earned,notes:r.correction_notes}));await S.post(N.bulkStoreScore().url,{scores:t}),p.success("All scores saved successfully")}catch(t){p.error("Failed to save all scores"),console.error(t)}},se=t=>{switch(t){case"ESSAY":return"bg-purple-100 text-purple-800 border-purple-200";case"MULTIPLE_CHOICE":return"bg-blue-100 text-blue-800 border-blue-200";default:return"bg-slate-100 text-slate-800 border-slate-200"}},M=()=>e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:a.length===0?e.jsx("div",{className:"text-center py-10 text-muted-foreground",children:"No questions found."}):a.map(t=>e.jsxs("div",{onClick:()=>J(t),className:T("cursor-pointer rounded-lg border p-4 transition-all hover:bg-accent",i?.id===t.id?"bg-accent border-primary ring-1 ring-primary":"bg-card"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("span",{className:"font-bold text-sm",children:["No. ",t.question_number]}),e.jsx(b,{variant:"outline",className:se(t.question_type),children:t.question_type})]}),e.jsx(me,{content:t.content,className:"text-xs text-muted-foreground line-clamp-3 prose prose-sm dark:prose-invert"}),e.jsxs("div",{className:"mt-2 text-xs font-medium text-right text-muted-foreground",children:["Max Score: ",t.score_value]})]},t.id))});return e.jsxs(oe,{breadcrumbs:[{title:"Exams",href:de.url()},{title:s.title,href:_.monitor({exam:s.id}).url},{title:"Manual Correction",href:"#"}],children:[e.jsx(te,{title:`Correction - ${s.title}`}),e.jsxs("div",{className:"h-[calc(100vh-4rem)] flex flex-col",children:[e.jsxs("header",{className:"border-b bg-background px-4 md:px-6 py-3 flex items-center justify-between shrink-0 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 md:gap-4 overflow-hidden",children:[e.jsx(h,{variant:"ghost",size:"icon",asChild:!0,className:"shrink-0",children:e.jsx(re,{href:_.monitor({exam:s.id}).url,children:e.jsx(be,{className:"h-5 w-5"})})}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("h1",{className:"text-lg font-semibold truncate",children:s.title}),e.jsx("p",{className:"text-sm text-muted-foreground hidden md:block",children:"Manual Correction Mode"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs(pe,{open:D,onOpenChange:I,children:[e.jsx(he,{asChild:!0,children:e.jsx(h,{variant:"outline",size:"icon",className:"md:hidden",children:e.jsx($,{className:"h-5 w-5"})})}),e.jsxs(fe,{side:"left",className:"w-[85vw] sm:w-[400px] p-0 flex flex-col",children:[e.jsx(ge,{className:"p-4 border-b",children:e.jsxs(je,{children:["Questions (",a.length,")"]})}),e.jsx(M,{})]})]}),e.jsxs(h,{variant:"outline",onClick:ee,disabled:k,size:"sm",children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Save All"}),e.jsx("span",{className:"inline sm:hidden",children:"Save"})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col md:flex-row",children:[e.jsxs("aside",{className:"hidden md:flex w-1/4 max-w-sm border-r bg-muted/10 flex-col",children:[e.jsxs("div",{className:"p-4 border-b font-medium bg-background/50 backdrop-blur",children:["Questions (",a.length,")"]}),e.jsx(M,{})]}),e.jsx("main",{className:"flex-1 flex flex-col bg-background overflow-hidden relative",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex flex-col sm:flex-row items-start sm:items-center justify-between bg-muted/10 gap-4",children:[e.jsxs("h2",{className:"font-semibold flex items-center gap-2 text-sm sm:text-base",children:["Grading Question #",i.question_number,e.jsxs(b,{variant:"secondary",className:"whitespace-nowrap",children:["Max: ",i.score_value]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-4 w-full sm:w-auto",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(P,{id:"select-all",checked:f.length>0&&x.length===f.length,onCheckedChange:t=>Z(!!t)}),e.jsx("label",{htmlFor:"select-all",className:"text-sm font-medium leading-none cursor-pointer",children:"Select All"})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full sm:w-auto",children:[e.jsx("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:"Bulk Score:"}),e.jsx(B,{type:"number",className:"w-20 h-8",value:C,onChange:t=>U(t.target.value),placeholder:"Score"}),e.jsxs(h,{size:"sm",variant:"secondary",onClick:Y,disabled:x.length===0,className:"whitespace-nowrap flex-1 sm:flex-none",children:["Apply (",x.length,")"]})]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 space-y-6",children:[e.jsxs(z,{className:"bg-blue-50/50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-800",children:[e.jsx(ie,{children:e.jsxs(le,{className:"text-base flex items-center gap-2",children:[e.jsx("span",{className:"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shrink-0",children:i.question_number}),"Question Content"]})}),e.jsx(G,{children:e.jsx(ue,{value:i.content,readOnly:!0,className:"prose prose-sm dark:prose-invert max-w-none"})})]}),k?e.jsx("div",{className:"text-center py-10",children:"Loading answers..."}):f.length===0?e.jsxs("div",{className:"text-center py-10 text-muted-foreground px-4",children:[e.jsx(Ne,{className:"mx-auto h-8 w-8 mb-2 opacity-50"}),"No answers found for this question yet."]}):f.map(t=>e.jsx(z,{className:T("transition-colors",x.includes(t.id)?"border-primary/50 bg-primary/5":""),children:e.jsxs(G,{className:"p-4 flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"pt-1 flex items-start gap-3 md:block",children:[e.jsx(P,{checked:x.includes(t.id),onCheckedChange:r=>Q(t.id,!!r)}),e.jsxs("div",{className:"flex md:hidden flex-col",children:[e.jsx("div",{className:"font-medium text-sm",children:t.student_name}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.student_email})]})]}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{className:"hidden md:flex items-center gap-2",children:[e.jsx("div",{className:"font-medium",children:t.student_name}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["(",t.student_email,")"]}),e.jsxs(b,{variant:"outline",className:"text-xs",children:["Upaya ke-",t.attempt_number]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground",children:"Student Answer:"}),e.jsxs(b,{variant:"outline",className:"text-xs md:hidden",children:["Att #",t.attempt_number]})]}),!t.student_answer&&e.jsx("div",{className:"p-4 rounded-md bg-muted/30 border text-sm text-muted-foreground italic mb-4",children:"No answer provided"}),(()=>{let r=t.student_answer;if(typeof r=="string")try{r=JSON.parse(r)}catch{r.startsWith('"')&&r.endsWith('"')&&(r=r.slice(1,-1))}return e.jsx(xe,{type:i.question_type,options:i.options,studentAnswer:r,keyAnswer:i.key_answer,showMedia:!1,showKeyAnswer:!0,showStudentAnswer:!0})})()]})]}),e.jsxs("div",{className:"w-full md:w-[300px] border-t pt-4 md:border-t-0 md:pt-0 md:border-l md:pl-6 space-y-4 flex flex-col",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(O,{children:["Score (Max: ",i.score_value,")"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{type:"number",value:t.score_earned,onChange:r=>E(t.id,r.target.value)}),e.jsx(h,{size:"icon",variant:"ghost",onClick:()=>V(t),children:e.jsx(q,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:Array.from({length:i.score_value},(r,o)=>o+1).map(r=>e.jsx(h,{type:"button",size:"sm",variant:t.score_earned===r?"default":"outline",className:"h-7 w-7 p-0 text-xs",onClick:()=>E(t.id,r.toString()),children:r},r))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(O,{children:"Notes"}),i.question_type==="essay"&&e.jsxs(h,{type:"button",variant:"outline",size:"xs",className:"h-6 gap-1.5 text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-700 border-indigo-200",onClick:()=>X(t),disabled:!!F||!t.student_answer,children:[F===t.id?e.jsx(ve,{className:"h-3 w-3 animate-spin"}):e.jsx(ye,{className:"h-3 w-3"}),"AI Grade"]})]}),e.jsx(ne,{placeholder:"Feedback...",className:"h-20 resize-none text-xs",value:t.correction_notes||"",onChange:r=>K(t.id,r.target.value)})]})]})]})},t.id))]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-center text-muted-foreground p-8",children:e.jsxs("div",{className:"max-w-md space-y-2",children:[e.jsx($,{className:"h-12 w-12 mx-auto opacity-20"}),e.jsx("p",{className:"font-semibold",children:"No Question Selected"}),e.jsx("p",{className:"text-sm",children:"Select a question from the list to start manual grading."})]})})})]})]})]})}export{gs as default};
